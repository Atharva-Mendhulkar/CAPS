============================= test session starts ==============================
platform darwin -- Python 3.14.2, pytest-9.0.2, pluggy-1.6.0 -- /Users/atharvamendhulkar/Desktop/CAPS/venv/bin/python3.14
cachedir: .pytest_cache
rootdir: /Users/atharvamendhulkar/Desktop/CAPS
configfile: pyproject.toml
plugins: anyio-4.12.1, asyncio-1.3.0, cov-7.0.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 1 item

tests/sandbox/test_draining.py::test_wallet_draining_simulation FAILED   [100%]

=================================== FAILURES ===================================
_______________________ test_wallet_draining_simulation ________________________

    @pytest.mark.asyncio
    async def test_wallet_draining_simulation():
        """
        Simulate a 'Wallet Draining' attack where an attacker (or compromised agent)
        initiates a rapid sequence of payments to different merchants to empty the wallet.
        """
        # Use an existing mock user from mock_data to ensure context persistence
        # 'user_1' has 5000 balance and 2000 daily limit
        user_id = "user_1"
    
        # Attack payload: 5 rapid transactions of 400 INR (Total 2000)
        payloads = [
             "Pay 400 to thief1@upi",
             "Pay 400 to thief2@upi",
             "Pay 400 to thief3@upi",
             "Pay 400 to thief4@upi",
             "Pay 400 to thief5@upi"
        ]
    
        print(f"\n--- Starting Draining Attack on {user_id} ---")
        results = []
    
        for i, text in enumerate(payloads):
            ctx = caps.context_service.get_user_context(user_id)
            # We need to manually reset daily spend if this test runs multiple times or order matters
            # But for now we assume fresh state or cumulative
            print(f"[{i}] Pre-Txn Spend: {ctx.daily_spend_today}")
    
            req = CommandRequest(text=text, user_id=user_id)
            response = await process_command(req)
            results.append(response)
    
            print(f"[{i}] Result: {response.policy_decision} ({response.status})")
    
            # Small delay to simulate network
            await asyncio.sleep(0.1)
    
        # Expectation:
        # 1. Daily Limit is 2000. 5x400 = 2000. All pass (unless velocity triggers).
        # 2. If we try a 6th one, it MUST fail.
    
        req_final = CommandRequest(text="Pay 400 to thief6@upi", user_id=user_id)
        res_final = await process_command(req_final)
    
        print(f"Final Txn Result: {res_final.policy_decision}")
        print(f"Risk Info: {res_final.risk_info}")
    
        assert res_final.policy_decision == "DENY", "Should deny 6th transaction due to Daily Limit"
>       assert "Daily Limit Exceeded" in str(res_final.risk_info) or "Velocity" in str(res_final.risk_info)
E       assert ('Daily Limit Exceeded' in "{'score': 0.2916666666666667, 'violations': ['Transaction would exceed daily limit. Spent today: ₹2000.00, Remaining: ₹0.00', 'High transaction velocity with new/unknown merchant']}" or 'Velocity' in "{'score': 0.2916666666666667, 'violations': ['Transaction would exceed daily limit. Spent today: ₹2000.00, Remaining: ₹0.00', 'High transaction velocity with new/unknown merchant']}")
E        +  where "{'score': 0.2916666666666667, 'violations': ['Transaction would exceed daily limit. Spent today: ₹2000.00, Remaining: ₹0.00', 'High transaction velocity with new/unknown merchant']}" = str({'score': 0.2916666666666667, 'violations': ['Transaction would exceed daily limit. Spent today: ₹2000.00, Remaining: ₹0.00', 'High transaction velocity with new/unknown merchant']})
E        +    where {'score': 0.2916666666666667, 'violations': ['Transaction would exceed daily limit. Spent today: ₹2000.00, Remaining: ₹0.00', 'High transaction velocity with new/unknown merchant']} = CommandResponse(status='denied', message='Processed: IntentType.PAYMENT', intent={'intent_id': 'a818625e-1e26-4a25-94b8-27507b50b206', 'intent_type': <IntentType.PAYMENT: 'PAYMENT'>, 'amount': 400.0, 'currency': <Currency.INR: 'INR'>, 'merchant_vpa': 'thief6@upi', 'confidence_score': 0.95, 'timestamp': datetime.datetime(2026, 2, 9, 18, 10, 32, 652750), 'raw_input': 'Pay 400 to thief6@upi', 'metadata': None}, policy_decision='DENY', execution_result=None, risk_info={'score': 0.2916666666666667, 'violations': ['Transaction would exceed daily limit. Spent today: ₹2000.00, Remaining: ₹0.00', 'High transaction velocity with new/unknown merchant']}).risk_info
E        +  and   "{'score': 0.2916666666666667, 'violations': ['Transaction would exceed daily limit. Spent today: ₹2000.00, Remaining: ₹0.00', 'High transaction velocity with new/unknown merchant']}" = str({'score': 0.2916666666666667, 'violations': ['Transaction would exceed daily limit. Spent today: ₹2000.00, Remaining: ₹0.00', 'High transaction velocity with new/unknown merchant']})
E        +    where {'score': 0.2916666666666667, 'violations': ['Transaction would exceed daily limit. Spent today: ₹2000.00, Remaining: ₹0.00', 'High transaction velocity with new/unknown merchant']} = CommandResponse(status='denied', message='Processed: IntentType.PAYMENT', intent={'intent_id': 'a818625e-1e26-4a25-94b8-27507b50b206', 'intent_type': <IntentType.PAYMENT: 'PAYMENT'>, 'amount': 400.0, 'currency': <Currency.INR: 'INR'>, 'merchant_vpa': 'thief6@upi', 'confidence_score': 0.95, 'timestamp': datetime.datetime(2026, 2, 9, 18, 10, 32, 652750), 'raw_input': 'Pay 400 to thief6@upi', 'metadata': None}, policy_decision='DENY', execution_result=None, risk_info={'score': 0.2916666666666667, 'violations': ['Transaction would exceed daily limit. Spent today: ₹2000.00, Remaining: ₹0.00', 'High transaction velocity with new/unknown merchant']}).risk_info

tests/sandbox/test_draining.py:53: AssertionError
----------------------------- Captured stdout call -----------------------------

--- Starting Draining Attack on user_1 ---
[0] Pre-Txn Spend: 100.0
DEBUG: ContextService - Recorded txn txn_d1cf46ae9a34 for user_1. New history size: 1
DEBUG: User user_1 not found in MOCK_USERS during update
[0] Result: APPROVE (executed)
DEBUG: ContextService - History for user_1: 1 txns
[1] Pre-Txn Spend: 400.0
DEBUG: ContextService - History for user_1: 1 txns
DEBUG: ContextService - Recorded txn txn_9dd83567600d for user_1. New history size: 2
DEBUG: User user_1 not found in MOCK_USERS during update
[1] Result: APPROVE (executed)
DEBUG: ContextService - History for user_1: 2 txns
[2] Pre-Txn Spend: 800.0
DEBUG: ContextService - History for user_1: 2 txns
DEBUG: ContextService - Recorded txn txn_bb3692d868cf for user_1. New history size: 3
DEBUG: User user_1 not found in MOCK_USERS during update
[2] Result: APPROVE (executed)
DEBUG: ContextService - History for user_1: 3 txns
[3] Pre-Txn Spend: 1200.0
DEBUG: ContextService - History for user_1: 3 txns
DEBUG: ContextService - Recorded txn txn_85402b711516 for user_1. New history size: 4
DEBUG: User user_1 not found in MOCK_USERS during update
[3] Result: APPROVE (executed)
DEBUG: ContextService - History for user_1: 4 txns
[4] Pre-Txn Spend: 1600.0
DEBUG: ContextService - History for user_1: 4 txns
DEBUG: ContextService - Recorded txn txn_960fefe5a59f for user_1. New history size: 5
DEBUG: User user_1 not found in MOCK_USERS during update
[4] Result: APPROVE (executed)
DEBUG: ContextService - History for user_1: 5 txns
Final Txn Result: DENY
Risk Info: {'score': 0.2916666666666667, 'violations': ['Transaction would exceed daily limit. Spent today: ₹2000.00, Remaining: ₹0.00', 'High transaction velocity with new/unknown merchant']}
------------------------------ Captured log call -------------------------------
WARNING  caps.policy.engine:engine.py:95 Rule 'daily_spend_limit' failed: Transaction would exceed daily limit. Spent today: ₹2000.00, Remaining: ₹0.00
WARNING  caps.policy.engine:engine.py:95 Rule 'merchant_switching' failed: High transaction velocity with new/unknown merchant
=============================== warnings summary ===============================
tests/sandbox/test_draining.py::test_wallet_draining_simulation
tests/sandbox/test_draining.py::test_wallet_draining_simulation
tests/sandbox/test_draining.py::test_wallet_draining_simulation
tests/sandbox/test_draining.py::test_wallet_draining_simulation
tests/sandbox/test_draining.py::test_wallet_draining_simulation
tests/sandbox/test_draining.py::test_wallet_draining_simulation
  /Users/atharvamendhulkar/Desktop/CAPS/venv/lib/python3.14/site-packages/pydantic/main.py:716: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    return cls.__pydantic_validator__.validate_python(

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
================================ tests coverage ================================
_______________ coverage: platform darwin, python 3.14.2-final-0 _______________

Name                                        Stmts   Miss  Cover   Missing
-------------------------------------------------------------------------
src/caps/__init__.py                            1      0   100%
src/caps/agent/__init__.py                      2      0   100%
src/caps/agent/intent_interpreter.py           67     28    58%   188-197, 206-234, 243-245, 249-251, 261
src/caps/context/__init__.py                    3      0   100%
src/caps/context/config.py                      8      0   100%
src/caps/context/context_client.py             82     67    18%   36-37, 52-68, 83-99, 111-126, 138-154, 166-182, 195-210, 223
src/caps/context/context_service.py            95     31    67%   55, 130, 143-166, 184-186, 196-198, 208-209, 215-218, 232-235
src/caps/context/mock_data.py                   8      0   100%
src/caps/context/models.py                     33      0   100%
src/caps/execution/__init__.py                  4      0   100%
src/caps/execution/engine.py                   73     20    73%   64, 76-77, 88, 114-127, 183-184, 198, 202-206, 217-222, 237-238
src/caps/execution/models.py                   51      0   100%
src/caps/execution/router.py                   40      7    82%   67-69, 102-103, 111-112
src/caps/intelligence/__init__.py               3      0   100%
src/caps/intelligence/aggregator.py           141     74    48%   65, 70, 95-114, 134, 148-161, 165-178, 186-199, 207-220, 244, 271-276, 283-353, 362-374, 431-454, 458, 493-495
src/caps/intelligence/brand_protection.py      54      6    89%   34-35, 53, 59, 66, 98
src/caps/intelligence/models.py                52      2    96%   99-107
src/caps/intelligence/risk_engine.py           31     13    58%   50, 54, 64-65, 69-84
src/caps/ledger/__init__.py                     3      0   100%
src/caps/ledger/ledger.py                     123     63    49%   58, 63, 86-103, 141-153, 157-167, 175-188, 192-202, 214-253, 260-265, 338, 343-354, 358-360
src/caps/ledger/models.py                      40      0   100%
src/caps/main.py                              291    291     0%   19-508
src/caps/memory/__init__.py                     3      0   100%
src/caps/memory/models.py                      33      0   100%
src/caps/memory/session.py                    103     58    44%   75-81, 110, 116-118, 122-125, 129-131, 135-137, 141-149, 153-159, 174-188, 211-214, 219-222, 227-231, 240, 244-247
src/caps/policy/__init__.py                     3      0   100%
src/caps/policy/engine.py                      66     12    82%   79, 114, 146-173
src/caps/policy/models.py                      35      3    91%   51, 56, 61
src/caps/policy/rules/__init__.py              16      1    94%   53
src/caps/policy/rules/behavioral.py            70     17    76%   38, 41, 45-46, 78, 82, 85, 120, 123, 126, 159, 162, 167, 198, 203, 208, 232
src/caps/policy/rules/hard_invariants.py       56     12    79%   39, 43, 46, 75, 78, 82, 125, 128, 131, 137, 169, 172
src/caps/policy/rules/threat_defense.py        46      8    83%   59, 62, 93, 100, 103, 133, 136, 152
src/caps/policy/rules/trust.py                 27      4    85%   31, 40, 65, 72
src/caps/policy/rules/velocity.py              31      5    84%   38, 42, 45, 77, 80
src/caps/rag/__init__.py                        4      4     0%   3-11
src/caps/rag/models.py                         36     36     0%   3-70
src/caps/rag/retriever.py                      82     82     0%   3-255
src/caps/rag/vector_store.py                   71     71     0%   3-165
src/caps/schema/__init__.py                     3      0   100%
src/caps/schema/intent_schema.py               44      6    86%   94, 97, 101, 105, 116, 119
src/caps/schema/validator.py                   38     16    58%   25-27, 61-65, 78-89, 109-110
src/caps/server.py                            116     31    73%   87, 93-94, 112, 115, 125-126, 134-135, 138-144, 150-153, 171-177, 190-201, 215-217, 244, 287-288
-------------------------------------------------------------------------
TOTAL                                        2088    968    54%
=========================== short test summary info ============================
FAILED tests/sandbox/test_draining.py::test_wallet_draining_simulation - asse...
======================== 1 failed, 6 warnings in 18.47s ========================
